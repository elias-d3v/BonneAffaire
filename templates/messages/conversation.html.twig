{% extends 'base.html.twig' %}

{% block body %}
<section class="conversation-page">
    <div class="conversation-header">
        <a href="{{ path('messages_inbox') }}" class="btn-back">← Retour</a>
        <h2>Conversation avec <span class="conversation-receiver-name">{{ otherUser.name }}</span></h2>
    </div>

    <div id="conversation" class="conversation-box">
        {% include 'messages/_conversation.html.twig' %}
    </div>

    <form id="message-form" method="post" action="{{ path('messages_send', {id: otherUser.id}) }}" class="message-form">
        <textarea name="content" placeholder="Écris ton message..." required></textarea>
        <button type="submit" class="btn-send">Envoyer</button>
    </form>
</section>

<script>
    // Fonction qui fait défiler automatiquement la boîte de conversation vers le bas
    function scrollToBottom() {
        // Sélectionne l’élément contenant la conversation
        const box = document.querySelector('#conversation');
        // Fait défiler jusqu'en bas du contenu
        box.scrollTop = box.scrollHeight;
    }

    // Fonction qui charge les messages depuis le serveur
    function loadMessages() {
        // Effectue une requête vers la route Symfony "messages_fetch"
        // Cette route renvoie le HTML des messages pour l'utilisateur concerné
        fetch("{{ path('messages_fetch', {id: otherUser.id}) }}")
            // Convertit la réponse en texte (ici, du HTML)
            .then(res => res.text())
            // Insère le HTML dans le conteneur de conversation
            .then(html => {
                document.querySelector('#conversation').innerHTML = html;
                // Fait défiler en bas pour afficher le dernier message
                scrollToBottom();
            });
    }

    // Exécute le code une fois la page entièrement chargée
    document.addEventListener("DOMContentLoaded", () => {
        // Charge les messages immédiatement au chargement de la page
        loadMessages();

        // Recharge les messages automatiquement toutes les 5 secondes
        setInterval(loadMessages, 5000);

        // Gère l’envoi du formulaire de message sans recharger la page
        document.querySelector("#message-form").addEventListener("submit", e => {
            // Empêche le comportement par défaut du formulaire (rechargement de la page)
            e.preventDefault();

            const form = e.target;

            // Envoie le formulaire en AJAX avec la méthode POST
            fetch(form.action, { method: "POST", body: new FormData(form) })
                // Une fois le message envoyé, vide le champ de texte
                .then(() => {
                    form.reset();
                    // Recharge les messages pour inclure le nouveau
                    loadMessages();
                });
        });
    });
</script>
{% endblock %}
